SET SCHEMA 'yelp_ds';

CREATE TABLE PHI_BUSINESS (
    ID INT NOT NULL,
    BUSINESS_ID  VARCHAR(32) NOT NULL UNIQUE,
    NAME VARCHAR(255) NOT NULL,
    ADDRESS  VARCHAR(255) NOT NULL,
    CITY VARCHAR(128) NOT NULL,
    STATE VARCHAR(8) NOT NULL,
    POSTAL_CODE VARCHAR(8) NOT NULL,
    LATITUDE FLOAT NOT NULL,
    LONGTITUDE FLOAT NOT NULL,
    STARS FLOAT NOT NULL,
    REVIEW_COUNT INT NOT NULL,
    IS_OPEN BOOLEAN NOT NULL,
    ATTRIBUTES JSONB,
    CATEGORIES JSONB,
    HOURS JSONB,
    PRIMARY KEY(ID)
);

CREATE TABLE PHI_CUSTOMER (
    ID INT NOT NULL,
    USER_ID  VARCHAR(32) NOT NULL UNIQUE,
    NAME VARCHAR(255) NOT NULL,
    REVIEW_COUNT INT,
    YELPING_SINCE TIMESTAMP,
    FRIENDS VARCHAR(32)[],
    USEFUL INT,
    FUNNY INT,
    COOL INT,
    FANS INT,
    ELITE INT[],
    AVERAGE_STARS FLOAT,
    COMPLIMENT_HOT INT,
    COMPLIMENT_MORE INT,
    COMPLIMENT_PROFILE INT,
    COMPLIMENT_CUTE INT,
    COMPLIMENT_LIST INT,
    COMPLIMENT_NOTE INT,
    COMPLIMENT_PLAIN INT,
    COMPLIMENT_COOL INT,
    COMPLIMENT_FUNNY INT,
    COMPLIMENT_WRITER INT,
    COMPLIMENT_PHOTOS INT,
    PRIMARY KEY(ID)
);

CREATE TABLE PHI_REVIEW (
    ID INT NOT NULL,
    REVIEW_ID  VARCHAR(32) NOT NULL UNIQUE,
    USER_ID  VARCHAR(32) NOT NULL,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    DATE TIMESTAMP,
    TEXT TEXT,
    STARS INT,
    USEFUL INT,
    FUNNY INT,
    COOL INT,
    PRIMARY KEY(ID),
    CONSTRAINT FK_PHI_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES PHI_BUSINESS(BUSINESS_ID),
    CONSTRAINT FK_PHI_CUSTOMER FOREIGN KEY(USER_ID) REFERENCES PHI_CUSTOMER(USER_ID)
);

CREATE TABLE PHI_TIP (
    ID INT NOT NULL,
    USER_ID  VARCHAR(32) NOT NULL,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    DATE TIMESTAMP,
    TEXT TEXT,
    COMPLIMENT_COUNT INT,
    PRIMARY KEY(ID),
    CONSTRAINT FK_PHI_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES PHI_BUSINESS(BUSINESS_ID),
    CONSTRAINT FK_PHI_CUSTOMER FOREIGN KEY(USER_ID) REFERENCES PHI_CUSTOMER(USER_ID)
);

CREATE TABLE PHI_CHECKIN (
    ID INT NOT NULL,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    DATE TIMESTAMP,
    PRIMARY KEY(ID),
    CONSTRAINT FK_PHI_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES PHI_BUSINESS(BUSINESS_ID)
);

INSERT INTO PHI_BUSINESS
SELECT * FROM BUSINESS B
WHERE B.POSTAL_CODE IN ('19149', '19150', '19151', '19019', '19093', '19092', '19099', '19101', '19103', '19102', '19104', '19107', '19109', '19110', '19112', '19115', '19119', '19120', '19105', '19106', '19108', '19111', '19113', '19114', '19116', '19118', '19121', '19122', '19125', '19128', '19129', '19123', '19124', '19126', '19127', '19130', '19131', '19132', '19133', '19136', '19137', '19140', '19141', '19144', '19145', '19148', '19134', '19135', '19138', '19139', '19142', '19143', '19146', '19147', '19152', '19153', '19155', '19160', '19170', '19172', '19173', '19154', '19161', '19162', '19171', '19175', '19178', '19182', '19183', '19185', '19187', '19176', '19177', '19179', '19181', '19184', '19188', '19192', '19194', '19195', '19197', '19244', '19190', '19191', '19193', '19196', '19255');

INSERT INTO PHI_CUSTOMER
SELECT C.* FROM CUSTOMER C, (
	SELECT DISTINCT R.USER_ID
	FROM PHI_BUSINESS PHIB, REVIEW R
	WHERE (PHIB.BUSINESS_ID = R.BUSINESS_ID)
) BR
WHERE (BR.USER_ID = C.USER_ID);

INSERT INTO PHI_REVIEW
SELECT R.* FROM REVIEW R, PHI_CUSTOMER PHIC, PHI_BUSINESS PHIB
WHERE (R.BUSINESS_ID = PHIB.BUSINESS_ID) AND (R.USER_ID = PHIC.USER_ID);

INSERT INTO PHI_TIP
SELECT T.* FROM TIP T, PHI_CUSTOMER PHIC, PHI_BUSINESS PHIB
WHERE (T.BUSINESS_ID = PHIB.BUSINESS_ID) AND (T.USER_ID = PHIC.USER_ID);

INSERT INTO PHI_CHECKIN
SELECT CH.* FROM CHECKIN CH, PHI_BUSINESS PHIB
WHERE (CH.BUSINESS_ID = PHIB.BUSINESS_ID);