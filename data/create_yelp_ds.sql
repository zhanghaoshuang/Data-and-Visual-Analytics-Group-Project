SET SCHEMA 'yelp_ds';

CREATE TABLE BUSINESS (
    ID INT GENERATED ALWAYS AS IDENTITY,
    BUSINESS_ID  VARCHAR(32) NOT NULL UNIQUE,
    NAME VARCHAR(255) NOT NULL,
    ADDRESS  VARCHAR(255) NOT NULL,
    CITY VARCHAR(128) NOT NULL,
    STATE VARCHAR(8) NOT NULL,
    POSTAL_CODE VARCHAR(8) NOT NULL,
    LATITUDE FLOAT NOT NULL,
    LONGTITUDE FLOAT NOT NULL,
    STARS FLOAT NOT NULL,
    REVIEW_COUNT INT NOT NULL,
    IS_OPEN BOOLEAN NOT NULL,
    ATTRIBUTES JSONB,
    CATEGORIES JSONB,
    HOURS JSONB,
    PRIMARY KEY(ID)
);

CREATE TABLE CUSTOMER (
    ID INT GENERATED ALWAYS AS IDENTITY,
    USER_ID  VARCHAR(32) NOT NULL UNIQUE,
    NAME VARCHAR(255) NOT NULL,
    REVIEW_COUNT INT,
    YELPING_SINCE TIMESTAMP,
    FRIENDS VARCHAR(32)[],
    USEFUL INT,
    FUNNY INT,
    COOL INT,
    FANS INT,
    ELITE INT[],
    AVERAGE_STARS FLOAT,
    COMPLIMENT_HOT INT,
    COMPLIMENT_MORE INT,
    COMPLIMENT_PROFILE INT,
    COMPLIMENT_CUTE INT,
    COMPLIMENT_LIST INT,
    COMPLIMENT_NOTE INT,
    COMPLIMENT_PLAIN INT,
    COMPLIMENT_COOL INT,
    COMPLIMENT_FUNNY INT,
    COMPLIMENT_WRITER INT,
    COMPLIMENT_PHOTOS INT,
    PRIMARY KEY(ID)
);

CREATE TABLE CUSTOMER_RELATIONSHIP (
    FIRST_USER_ID  VARCHAR(32) NOT NULL,
    SECOND_USER_ID  VARCHAR(32) NOT NULL,
    PRIMARY KEY (FIRST_USER_ID, SECOND_USER_ID),
    CONSTRAINT FK_CUSTOMER_1 FOREIGN KEY(FIRST_USER_ID) REFERENCES CUSTOMER(USER_ID),
    CONSTRAINT FK_CUSTOMER_2 FOREIGN KEY(SECOND_USER_ID) REFERENCES CUSTOMER(USER_ID),
    CHECK (FIRST_USER_ID <> SECOND_USER_ID)
);

CREATE TABLE CHECKIN (
    ID INT GENERATED ALWAYS AS IDENTITY,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    DATE TIMESTAMP,
    PRIMARY KEY(ID),
    CONSTRAINT FK_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES BUSINESS(BUSINESS_ID)
);

CREATE TABLE REVIEW (
    ID INT GENERATED ALWAYS AS IDENTITY,
    REVIEW_ID  VARCHAR(32) NOT NULL UNIQUE,
    USER_ID  VARCHAR(32) NOT NULL,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    DATE TIMESTAMP,
    TEXT TEXT,
    STARS INT,
    USEFUL INT,
    FUNNY INT,
    COOL INT,
    PRIMARY KEY(ID),
    CONSTRAINT FK_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES BUSINESS(BUSINESS_ID),
    CONSTRAINT FK_CUSTOMER FOREIGN KEY(USER_ID) REFERENCES CUSTOMER(USER_ID)
);

CREATE TABLE TIP (
    ID INT GENERATED ALWAYS AS IDENTITY,
    USER_ID  VARCHAR(32) NOT NULL,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    DATE TIMESTAMP,
    TEXT TEXT,
    COMPLIMENT_COUNT INT,
    PRIMARY KEY(ID),
    CONSTRAINT FK_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES BUSINESS(BUSINESS_ID),
    CONSTRAINT FK_CUSTOMER FOREIGN KEY(USER_ID) REFERENCES CUSTOMER(USER_ID)
);

CREATE TABLE PHOTO (
    ID INT GENERATED ALWAYS AS IDENTITY,
    PHOTO_ID  VARCHAR(32) NOT NULL UNIQUE,
    BUSINESS_ID  VARCHAR(32) NOT NULL,
    CAPTION TEXT,
    LABEL VARCHAR(128),
    PRIMARY KEY(ID),
    CONSTRAINT FK_BUSINESS FOREIGN KEY(BUSINESS_ID) REFERENCES BUSINESS(BUSINESS_ID)
);