SET SCHEMA 'yelp_ds';

SELECT PHI_BI.ID, PHI_BI.BUSINESS_ID, PHI_BI.NAME, PHI_BI.STARS, PHI_BI.REVIEW_COUNT, 
PHI_BI.POSTAL_CODE, PHI_BI.LATITUDE, PHI_BI.LONGTITUDE, PHI_BI.IS_OPEN,
PHI_RE_DEMAND.COMP_STARS, PHI_RE_DEMAND.COMP_REVIEW_COUNT, 
(PHI_RE_DEMAND.RE_DEMAND_SCORE + COALESCE(PHI_TIP_DEMAND.TIP_DEMAND_SCORE, 0) + COALESCE(PHI_CH_DEMAND.CHECKIN_COUNT, 0)) TOTAL_DEMAND_SCORE, 
PHI_RE_DEMAND.MISSING_DEMAND_SCORE
FROM PHI_BUSINESS AS PHI_BI 
LEFT OUTER JOIN (
	SELECT PHI_RE.BUSINESS_ID,
	AVG(PHI_RE.STARS) COMP_STARS, 
	COUNT(PHI_RE.ID) COMP_REVIEW_COUNT,
	SUM(1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) AS RE_DEMAND_SCORE,
	SUM(CASE WHEN PHI_RE.STARS IN (1, 2, 3) THEN (1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) ELSE 0 END) AS MISSING_DEMAND_SCORE,
	SUM(CASE WHEN PHI_RE.STARS = 5 THEN (1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) ELSE 0 END) AS REVIEW_SCORE_5,
	SUM(CASE WHEN PHI_RE.STARS = 4 THEN (1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) ELSE 0 END) AS REVIEW_SCORE_4,
	SUM(CASE WHEN PHI_RE.STARS = 3 THEN (1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) ELSE 0 END) AS REVIEW_SCORE_3,
	SUM(CASE WHEN PHI_RE.STARS = 2 THEN (1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) ELSE 0 END) AS REVIEW_SCORE_2,
	SUM(CASE WHEN PHI_RE.STARS = 1 THEN (1 + PHI_RE.USEFUL + PHI_RE.FUNNY + PHI_RE.COOL) ELSE 0 END) AS REVIEW_SCORE_1
	FROM PHI_REVIEW AS PHI_RE
	GROUP BY PHI_RE.BUSINESS_ID
) AS PHI_RE_DEMAND ON (PHI_RE_DEMAND.BUSINESS_ID = PHI_BI.BUSINESS_ID)
LEFT OUTER JOIN (
	SELECT PHI_TIP.BUSINESS_ID,
	SUM(1 + PHI_TIP.COMPLIMENT_COUNT) AS TIP_DEMAND_SCORE
	FROM PHI_TIP
	GROUP BY PHI_TIP.BUSINESS_ID
) AS PHI_TIP_DEMAND ON (PHI_TIP_DEMAND.BUSINESS_ID = PHI_BI.BUSINESS_ID)
LEFT OUTER JOIN (
	SELECT PHI_CH.BUSINESS_ID,
	COUNT(PHI_CH.ID) CHECKIN_COUNT
	FROM PHI_CHECKIN PHI_CH
	GROUP BY PHI_CH.BUSINESS_ID
) AS PHI_CH_DEMAND ON (PHI_CH_DEMAND.BUSINESS_ID = PHI_BI.BUSINESS_ID)
ORDER BY MISSING_DEMAND_SCORE DESC;